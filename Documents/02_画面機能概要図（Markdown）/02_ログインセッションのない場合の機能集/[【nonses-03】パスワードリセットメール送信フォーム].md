# [【nonses-03】パスワードリセットメール送信フォーム]

- 【nonses-03】機能説明
  - 特徴・機能
    - アカウントを有するユーザーが、パスワードを忘れた、または再設定したい場合にこのフォームに入力してもらう
    - 入力されたメールアドレスに、パスワード再設定ページ遷移用の URL を載せたメールを送信する
  - 関連機能
    - 設定なし
  - 関連変数
    - flag.isPasswordResetMailFormOpen（boolean 型。初期状態は false）
- 【nonses-03-01】ログイン ID（email アドレス）入力欄
  - 特徴・機能
    - 登録するアカウントのログイン ID（email アドレス）を入力できる
    - 「ログイン ID（email アドレス）」のラベルを入力欄に設定する
    - メールアドレス形式の必要あり。半角英数字と一部特殊記号の入力が可能
    - 長さは 100 文字以内
    - 入力必須の項目
  - 関連変数
    - resetMailForm.loginId（String 型）
- 【nonses-03-02】Gmail アドレス入力欄
  - 特徴・機能
    - パスワード再設定メール送信先の Gmail アドレスを入力できる
    - 「Gmail アドレス」のラベルを入力欄に設定する
    - Gmail のメールアドレス形式の必要あり。半角英数字と一部特殊記号の入力が可能
    - 長さは 100 文字以内
    - 入力必須の項目
  - 関連変数
    - resetMailForm.gmail（String 型）
- 【nonses-03-03】アプリパスワード入力欄
  - 特徴・機能
    - Gmail アドレス用のパスワードを入力できる
    - 「アプリパスワード」のラベルを入力欄に設定する
    - 入力欄のタイプは text でなく password
    - 全角文字は入力できない
    - 入力必須の項目
  - 関連変数
    - resetMailForm.password（String 型）
- 【nonses-03-04】送信ボタン
  - 特徴・機能
    - 初期状態は非活性
      - メールアドレス入力欄が入力済みの状態になると活性化する
    - バリデーションを実施した上で、入力内容を API に送り、レスポンスを受け取る
      - バリデーションでは以下の判定を行う
        - メールアドレス入力欄の入力内容がメールアドレスの形式ではない
      - バリデーションが通った場合は、入力内容を API の PHP に送信する
        - サーバー側 API に送信するオブジェクト変数「param」には、次の内容を格納する
          - 『type: "generateResetPassMail"』
          - 『loginId: resetMailForm.loginId』
          - 『gmail: resetMailForm.gmail』
          - 『password: resetMailForm.password』
          - 『token: {ランダムな半角英数字 16 文字}』
      - API への送信が成功した場合は、次の文面のメールを送信してもらう
        - 件名: 【U-Linker】パスワード再設定のご案内
          - 『いつも U-Linker をご利用いただき、ありがとうございます。』
          - 『（空白）』
          - 『パスワード再設定のリクエストを受け付けました。』
          - 『下記のリンクからパスワードの再設定を行ってください。』
          - 『このリンクは安全のため、30分後に無効となります。』
          - 『{パスワード再設定ページリンク}』
            - テーブル「ulinker_accounts」に、送信先メールアドレスと合致する「email」を持つユーザーが存在していない場合
              - ワンタイムトークンを「XXXXX」とし、URL パラメータの「?onetime_token=」に設定する
            - テーブル「ulinker_accounts」に、送信先メールアドレスと合致する「email」を持つユーザーが存在していた場合
              - PHP プログラム上でワンタイムトークンと有効期限時間を設定
                - 「ulinker_accounts」内では対象ユーザーの「token」にワンタイムトークンを設定する
                  - ワンタイムトークンは、ランダムな半角英数字 16 文字
                - 「ulinker_accounts」内では対象ユーザーの「token_limit」に有効期限時間を設定する
                  - 有効期限時間は、メール送信処理成功時から 30 分後
              - ワンタイムトークンを URL パラメータの「?onetime_token=」に設定する
                - パスワード再設定ページ（resetpass.php）では、URL パスに設定された onetime_token で、パスワード再設定の可否を判定する
                  - 再設定可の場合は resetpass.php の画面機能を通常通り表示する
                  - 再設定不可の場合は、その旨のメッセージと、index.php への同タブ遷移用リンクを表示する
          - 『このメールに心当たりがない場合は、このメールを無視していただくか、』
          - 『U-Linker 管理者 {管理者名} までご連絡ください。』
            - 管理者名: テーブル「ulinker_accounts」で、「is_teacher」が 1 のユーザーのうち id が最も若いユーザーの user_name
          - 『（空白）』
          - 『※このメールは送信専用のため、返信いただいてもお答え致しかねます。』
          - 『------------------------------』
          - 『U-Linker 管理者 {管理者名}』
          - 『{U-Linker の index.php ページの URL}』
      - レスポンスが、送信完了を意味する判定であれば、その旨を伝えるメッセージを表示する
        - 送信に失敗した場合はその旨のメッセージを表示する
        - 3 秒後にブラウザがリロードされる
  - 関連変数
    - loginForm（Object 型）
